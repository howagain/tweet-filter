<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitter Intelligence Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      color: #e2e8f0;
      margin: 0;
      padding: 20px;
      line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #1e293b;
    }
    header h1 { color: #3b82f6; margin-bottom: 5px; font-size: 24px; }
    header p { color: #64748b; font-size: 14px; }
    
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-value { font-size: 32px; font-weight: 700; color: #3b82f6; }
    .stat-label { font-size: 12px; color: #64748b; }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .section-header h2 { font-size: 18px; margin: 0; }
    
    .topics-grid {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .topic-card {
      background: #1e293b;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #334155;
    }
    .topic-header {
      padding: 16px;
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .importance-badge {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
    }
    .importance-high { background: linear-gradient(135deg, #10b981, #059669); }
    .importance-med { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .importance-low { background: linear-gradient(135deg, #64748b, #475569); }
    
    .topic-info { flex: 1; }
    .topic-name { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .topic-summary { font-size: 13px; color: #94a3b8; }
    .topic-meta {
      display: flex;
      gap: 15px;
      font-size: 12px;
      color: #64748b;
      margin-top: 8px;
    }
    
    .topic-content { padding: 16px; }
    
    .relevance-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .relevance-tag {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .relevance-high { background: #10b981; color: white; }
    .relevance-med { background: #3b82f6; color: white; }
    .relevance-low { background: #334155; color: #94a3b8; }
    
    .tweets-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tweet-mini {
      background: #0f172a;
      padding: 12px;
      border-radius: 10px;
      display: flex;
      gap: 12px;
    }
    .tweet-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .tweet-body { flex: 1; min-width: 0; }
    .tweet-author { font-size: 12px; color: #3b82f6; margin-bottom: 4px; }
    .tweet-text { font-size: 13px; color: #cbd5e1; }
    .tweet-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .tweet-btn {
      padding: 4px 10px;
      border-radius: 6px;
      border: none;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tweet-btn:hover { transform: scale(1.05); }
    .btn-good { background: #10b981; color: white; }
    .btn-bad { background: #ef4444; color: white; }
    .btn-link { background: #334155; color: #94a3b8; }
    
    .content-opp {
      margin-top: 15px;
      padding: 12px;
      background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%);
      border-radius: 10px;
      border: 1px solid #4f46e5;
    }
    .content-opp-label { font-size: 11px; color: #a5b4fc; margin-bottom: 6px; }
    .content-opp-text { font-size: 13px; color: #e0e7ff; }
    
    .projects-section {
      background: #1e293b;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .project-card {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px;
      background: #0f172a;
      border-radius: 10px;
      margin-top: 10px;
    }
    .project-icon { font-size: 24px; }
    .project-name { font-weight: 600; }
    .project-desc { font-size: 12px; color: #64748b; }
    
    .refresh-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
    }
    .refresh-btn:hover { transform: scale(1.05); }
    
    .loading { text-align: center; padding: 40px; color: #64748b; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üß† Twitter Intelligence Dashboard</h1>
      <p>Knowledge graph of trending topics, ranked by importance and relevance to your projects</p>
    </header>
    
    <div class="stats-row" id="statsRow">
      <div class="stat-card">
        <div class="stat-value" id="topicCount">-</div>
        <div class="stat-label">Topics Tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="tweetCount">-</div>
        <div class="stat-label">Tweets Analyzed</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="highRelevance">-</div>
        <div class="stat-label">High Relevance</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="lastUpdate">-</div>
        <div class="stat-label">Last Update</div>
      </div>
    </div>
    
    <div class="projects-section">
      <div class="section-header">
        <h2>üìå Your Projects</h2>
      </div>
      <div id="projectsList"></div>
    </div>
    
    <div class="section-header">
      <h2>üìä Topic Clusters</h2>
      <span style="color: #64748b; font-size: 13px;">Ranked by global importance</span>
    </div>
    
    <div class="topics-grid" id="topicsGrid">
      <div class="loading">Loading topics...</div>
    </div>
  </div>
  
  <button class="refresh-btn" onclick="refresh()">üîÑ Fetch New Tweets</button>

  <script>
    const API = 'http://localhost:3456/api';
    
    let allTweets = [];
    let allTopics = [];
    let allProjects = [];
    
    async function load() {
      try {
        const [tweets, topics, projects] = await Promise.all([
          fetch(`${API}/tweets`).then(r => r.json()),
          fetch(`${API}/topics`).then(r => r.json()),
          fetch(`${API}/projects`).then(r => r.json())
        ]);
        
        allTweets = tweets;
        allTopics = topics.sort((a, b) => (b.importance || 0) - (a.importance || 0));
        allProjects = projects;
        
        render();
      } catch (e) {
        console.error('Failed to load:', e);
        document.getElementById('topicsGrid').innerHTML = 
          '<div class="loading">Failed to connect to API. Make sure server is running.</div>';
      }
    }
    
    function render() {
      // Stats
      document.getElementById('topicCount').textContent = allTopics.length;
      document.getElementById('tweetCount').textContent = allTweets.length;
      document.getElementById('highRelevance').textContent = 
        allTopics.filter(t => t.importance >= 50).length;
      document.getElementById('lastUpdate').textContent = 'Now';
      
      // Projects
      document.getElementById('projectsList').innerHTML = allProjects.map(p => `
        <div class="project-card">
          <div class="project-icon">üéØ</div>
          <div>
            <div class="project-name">${p.name}</div>
            <div class="project-desc">${p.description}</div>
          </div>
        </div>
      `).join('');
      
      // Topics
      document.getElementById('topicsGrid').innerHTML = allTopics.map(topic => {
        const impClass = topic.importance >= 80 ? 'importance-high' : 
                         topic.importance >= 40 ? 'importance-med' : 'importance-low';
        
        // Find matching tweets
        const matchingTweets = findTweetsForTopic(topic);
        
        // Calculate relevance to each project
        const relevances = allProjects.map(proj => {
          const score = calculateRelevance(topic, proj);
          return { name: proj.name, score };
        }).filter(r => r.score > 0).sort((a, b) => b.score - a.score);
        
        // Generate content opportunity
        const contentOpp = generateContentOpportunity(topic, relevances);
        
        return `
          <div class="topic-card">
            <div class="topic-header">
              <div class="importance-badge ${impClass}">${topic.importance}</div>
              <div class="topic-info">
                <div class="topic-name">${topic.name}</div>
                <div class="topic-summary">${topic.summary}</div>
                <div class="topic-meta">
                  <span>üìä ${topic.tweetCount || matchingTweets.length} tweets</span>
                  <span>üîó ${topic.keywords?.length || 0} keywords</span>
                </div>
              </div>
            </div>
            <div class="topic-content">
              ${relevances.length ? `
                <div class="relevance-bar">
                  ${relevances.map(r => `
                    <span class="relevance-tag ${r.score >= 3 ? 'relevance-high' : r.score >= 2 ? 'relevance-med' : 'relevance-low'}">
                      ${r.name}: ${r.score}/5
                    </span>
                  `).join('')}
                </div>
              ` : ''}
              
              <div class="tweets-list">
                ${matchingTweets.slice(0, 3).map(tweet => `
                  <div class="tweet-mini">
                    <div class="tweet-avatar">${tweet.author?.charAt(0) || '?'}</div>
                    <div class="tweet-body">
                      <div class="tweet-author">@${tweet.author || tweet.authorHandle}</div>
                      <div class="tweet-text">${tweet.text?.slice(0, 150)}...</div>
                      <div class="tweet-actions">
                        <button class="tweet-btn btn-good" onclick="rate('${tweet.id}', 'good')">üëç</button>
                        <button class="tweet-btn btn-bad" onclick="rate('${tweet.id}', 'bad')">üëé</button>
                        <a href="${tweet.url}" target="_blank" class="tweet-btn btn-link">‚Üó View</a>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
              
              ${contentOpp ? `
                <div class="content-opp">
                  <div class="content-opp-label">üí° Content Opportunity</div>
                  <div class="content-opp-text">${contentOpp}</div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function findTweetsForTopic(topic) {
      if (!topic.keywords?.length) return [];
      
      return allTweets.filter(tweet => {
        const text = tweet.text?.toLowerCase() || '';
        return topic.keywords.some(kw => text.includes(kw.toLowerCase()));
      });
    }
    
    function calculateRelevance(topic, project) {
      const topicKeywords = topic.keywords || [];
      const projectKeywords = project.keywords || [];
      
      let matches = 0;
      for (const pk of projectKeywords) {
        for (const tk of topicKeywords) {
          if (tk.includes(pk) || pk.includes(tk)) matches++;
        }
      }
      
      // Also check topic name/summary against project keywords
      const topicText = (topic.name + ' ' + topic.summary).toLowerCase();
      for (const pk of projectKeywords) {
        if (topicText.includes(pk.toLowerCase())) matches++;
      }
      
      return Math.min(5, matches);
    }
    
    function generateContentOpportunity(topic, relevances) {
      if (!relevances.length || relevances[0].score < 2) return null;
      
      const templates = [
        `Thread: How ${topic.name} relates to ${relevances[0].name}`,
        `Analysis: What ${topic.name} means for builders in this space`,
        `Quick take: ${topic.name} ‚Äî signal or noise?`,
        `Deep dive: The implications of ${topic.name}`
      ];
      
      return templates[Math.floor(Math.random() * templates.length)];
    }
    
    async function rate(tweetId, rating) {
      try {
        await fetch(`${API}/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tweetId, rating })
        });
        
        // Visual feedback
        event.target.style.transform = 'scale(1.2)';
        event.target.style.opacity = '0.5';
        setTimeout(() => {
          event.target.style.transform = '';
          event.target.disabled = true;
        }, 200);
      } catch (e) {
        console.error('Failed to save rating:', e);
      }
    }
    
    function refresh() {
      alert('Fetching new tweets... (This would trigger the Kernel scraper)');
      // In production: call backend to fetch new tweets, re-cluster, reload
    }
    
    load();
  </script>
</body>
</html>
