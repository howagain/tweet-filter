<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitter Intelligence Dashboard</title>
  <script src="https://unpkg.com/convex@1.17.4/dist/browser.bundle.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0f; color: #e2e8f0; margin: 0; padding: 20px; line-height: 1.5; }
    .container { max-width: 900px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #1e293b; }
    header h1 { color: #3b82f6; margin-bottom: 5px; font-size: 24px; }
    header p { color: #64748b; font-size: 14px; }
    .live-badge { display: inline-block; background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    
    .stats-row { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; }
    .stat-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 15px 25px; border-radius: 12px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: 700; color: #3b82f6; }
    .stat-label { font-size: 11px; color: #64748b; }
    
    .section { margin-bottom: 30px; }
    .section-title { font-size: 14px; color: #94a3b8; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    
    .project-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: #1e293b; border-radius: 10px; margin-bottom: 8px; }
    .project-icon { font-size: 20px; }
    .project-name { font-weight: 600; font-size: 14px; }
    .project-desc { font-size: 11px; color: #64748b; }
    
    .topic-card { background: #1e293b; border-radius: 16px; margin-bottom: 20px; overflow: hidden; border: 1px solid #334155; }
    .topic-header { padding: 16px; background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%); display: flex; align-items: center; gap: 15px; }
    .importance-badge { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; }
    .importance-high { background: linear-gradient(135deg, #10b981, #059669); }
    .importance-med { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .importance-low { background: linear-gradient(135deg, #64748b, #475569); }
    .topic-info { flex: 1; }
    .topic-name { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .topic-summary { font-size: 13px; color: #94a3b8; }
    .topic-meta { display: flex; gap: 15px; font-size: 12px; color: #64748b; margin-top: 8px; }
    
    .topic-content { padding: 16px; }
    .tweet-mini { background: #0f172a; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
    .tweet-author { font-size: 12px; color: #3b82f6; margin-bottom: 4px; }
    .tweet-text { font-size: 13px; color: #cbd5e1; }
    .tweet-actions { display: flex; gap: 8px; margin-top: 8px; }
    .tweet-btn { padding: 4px 10px; border-radius: 6px; border: none; font-size: 11px; cursor: pointer; }
    .btn-good { background: #10b981; color: white; }
    .btn-bad { background: #ef4444; color: white; }
    .btn-link { background: #334155; color: #94a3b8; text-decoration: none; }
    
    .loading { text-align: center; padding: 40px; color: #64748b; }
    .error { background: #7f1d1d; color: #fecaca; padding: 15px; border-radius: 10px; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üß† Twitter Intelligence Dashboard <span class="live-badge">LIVE</span></h1>
      <p>Real-time knowledge graph ‚Ä¢ Powered by Convex</p>
    </header>
    
    <div class="stats-row" id="stats">
      <div class="stat-card"><div class="stat-value" id="topicCount">-</div><div class="stat-label">Topics</div></div>
      <div class="stat-card"><div class="stat-value" id="tweetCount">-</div><div class="stat-label">Tweets</div></div>
      <div class="stat-card"><div class="stat-value" id="projectCount">-</div><div class="stat-label">Projects</div></div>
    </div>
    
    <div class="section">
      <div class="section-title">üìå Your Projects</div>
      <div id="projects"><div class="loading">Loading projects...</div></div>
    </div>
    
    <div class="section">
      <div class="section-title">üìä Topic Clusters (ranked by importance)</div>
      <div id="topics"><div class="loading">Loading topics...</div></div>
    </div>
  </div>

  <script>
    const CONVEX_URL = "https://adorable-boar-892.convex.cloud";
    const client = new Convex.ConvexHttpClient(CONVEX_URL);
    
    let tweets = [];
    let topics = [];
    let projects = [];
    
    async function load() {
      try {
        [tweets, topics, projects] = await Promise.all([
          client.query("tweets:listTweets", { limit: 100 }),
          client.query("topics:listTopics", {}),
          client.query("projects:listProjects", {})
        ]);
        
        document.getElementById('tweetCount').textContent = tweets.length;
        document.getElementById('topicCount').textContent = topics.length;
        document.getElementById('projectCount').textContent = projects.length;
        
        renderProjects();
        renderTopics();
      } catch (e) {
        console.error('Load error:', e);
        document.getElementById('topics').innerHTML = `<div class="error">Error loading: ${e.message}</div>`;
      }
    }
    
    function renderProjects() {
      document.getElementById('projects').innerHTML = projects.map(p => `
        <div class="project-card">
          <div class="project-icon">üéØ</div>
          <div>
            <div class="project-name">${p.name}</div>
            <div class="project-desc">${p.description}</div>
          </div>
        </div>
      `).join('');
    }
    
    function renderTopics() {
      const sorted = topics.sort((a, b) => (b.importance || 0) - (a.importance || 0));
      
      document.getElementById('topics').innerHTML = sorted.map(topic => {
        const impClass = (topic.importance || 0) >= 80 ? 'importance-high' : 
                         (topic.importance || 0) >= 40 ? 'importance-med' : 'importance-low';
        
        // Find matching tweets
        const matching = tweets.filter(t => {
          const text = (t.text || '').toLowerCase();
          return (topic.keywords || []).some(kw => text.includes(kw.toLowerCase()));
        });
        
        return `
          <div class="topic-card">
            <div class="topic-header">
              <div class="importance-badge ${impClass}">${topic.importance || 0}</div>
              <div class="topic-info">
                <div class="topic-name">${topic.name}</div>
                <div class="topic-summary">${topic.summary}</div>
                <div class="topic-meta">
                  <span>üìä ${matching.length} tweets</span>
                  <span>üîó ${(topic.keywords || []).length} keywords</span>
                </div>
              </div>
            </div>
            <div class="topic-content">
              ${matching.slice(0, 3).map(t => `
                <div class="tweet-mini">
                  <div class="tweet-author">@${t.authorHandle || t.author}</div>
                  <div class="tweet-text">${(t.text || '').slice(0, 200)}...</div>
                  <div class="tweet-actions">
                    <button class="tweet-btn btn-good" onclick="rate('${t._id}', 'good')">üëç</button>
                    <button class="tweet-btn btn-bad" onclick="rate('${t._id}', 'bad')">üëé</button>
                    <a href="${t.url}" target="_blank" class="tweet-btn btn-link">‚Üó View</a>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function rate(tweetId, rating) {
      try {
        await client.mutation("feedback:saveFeedback", { tweetId, rating });
        event.target.style.opacity = '0.5';
        event.target.disabled = true;
      } catch (e) {
        console.error('Rate error:', e);
      }
    }
    
    load();
  </script>
</body>
</html>
