<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitter Intelligence Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0f; color: #e2e8f0; margin: 0; padding: 20px; line-height: 1.5; }
    .container { max-width: 900px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #1e293b; }
    header h1 { color: #3b82f6; margin-bottom: 5px; font-size: 24px; }
    header p { color: #64748b; font-size: 14px; }
    .live-badge { display: inline-block; background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px; }
    
    .stats-row { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; }
    .stat-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 15px 25px; border-radius: 12px; text-align: center; min-width: 100px; }
    .stat-value { font-size: 28px; font-weight: 700; color: #3b82f6; }
    .stat-label { font-size: 11px; color: #64748b; }
    
    .section { margin-bottom: 30px; }
    .section-title { font-size: 14px; color: #94a3b8; margin-bottom: 15px; }
    
    .project-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: #1e293b; border-radius: 10px; margin-bottom: 8px; }
    .project-icon { font-size: 20px; }
    .project-name { font-weight: 600; font-size: 14px; }
    .project-desc { font-size: 11px; color: #64748b; }
    
    .topic-card { background: #1e293b; border-radius: 16px; margin-bottom: 20px; overflow: hidden; border: 1px solid #334155; }
    .topic-header { padding: 16px; background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%); display: flex; align-items: center; gap: 15px; }
    .topic-badge { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .topic-info { flex: 1; }
    .topic-name { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .topic-summary { font-size: 13px; color: #94a3b8; }
    .topic-meta { display: flex; gap: 15px; font-size: 12px; color: #64748b; margin-top: 8px; }
    
    .topic-content { padding: 16px; }
    .tweet-mini { background: #0f172a; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
    .tweet-author { font-size: 12px; color: #3b82f6; margin-bottom: 4px; }
    .tweet-text { font-size: 13px; color: #cbd5e1; }
    .tweet-link { color: #64748b; font-size: 11px; text-decoration: none; display: inline-block; margin-top: 6px; }
    
    .loading { text-align: center; padding: 40px; color: #64748b; }
    .error { background: #7f1d1d; color: #fecaca; padding: 15px; border-radius: 10px; margin: 20px 0; }
    #debug { background: #1e293b; padding: 10px; border-radius: 8px; font-size: 11px; color: #94a3b8; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ§  Twitter Intelligence Dashboard <span class="live-badge">LIVE</span></h1>
      <p>Real-time knowledge graph â€¢ Convex Backend</p>
    </header>
    
    <div class="stats-row">
      <div class="stat-card"><div class="stat-value" id="tweetCount">-</div><div class="stat-label">Tweets</div></div>
      <div class="stat-card"><div class="stat-value" id="topicCount">-</div><div class="stat-label">Topics</div></div>
      <div class="stat-card"><div class="stat-value" id="projectCount">-</div><div class="stat-label">Projects</div></div>
    </div>
    
    <div class="section">
      <div class="section-title">ðŸ“Œ Your Projects</div>
      <div id="projects"><div class="loading">Loading...</div></div>
    </div>
    
    <div class="section">
      <div class="section-title">ðŸ“Š Topic Clusters</div>
      <div id="topics"><div class="loading">Loading...</div></div>
    </div>
    
    <div id="debug"></div>
  </div>

  <script type="module">
    const CONVEX_URL = "https://adorable-boar-892.convex.cloud";
    
    // Simple HTTP fetch for Convex queries
    async function query(name, args = {}) {
      const [file, fn] = name.split(':');
      const res = await fetch(`${CONVEX_URL}/api/query`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          path: `${file}:${fn}`,
          args: args
        })
      });
      const data = await res.json();
      if (data.status === 'success') return data.value;
      throw new Error(data.errorMessage || 'Query failed');
    }
    
    let tweets = [], topics = [], projects = [];
    
    async function load() {
      const debug = document.getElementById('debug');
      try {
        debug.textContent = 'Loading from Convex...';
        
        [tweets, topics, projects] = await Promise.all([
          query('tweets:listTweets', { limit: 100 }),
          query('topics:listTopics'),
          query('projects:listProjects')
        ]);
        
        debug.textContent = `Loaded: ${tweets.length} tweets, ${topics.length} topics, ${projects.length} projects`;
        
        document.getElementById('tweetCount').textContent = tweets.length;
        document.getElementById('topicCount').textContent = topics.length;
        document.getElementById('projectCount').textContent = projects.length;
        
        renderProjects();
        renderTopics();
      } catch (e) {
        debug.textContent = 'Error: ' + e.message;
        console.error(e);
      }
    }
    
    function renderProjects() {
      document.getElementById('projects').innerHTML = projects.map(p => `
        <div class="project-card">
          <div class="project-icon">ðŸŽ¯</div>
          <div>
            <div class="project-name">${p.name}</div>
            <div class="project-desc">${p.description}</div>
          </div>
        </div>
      `).join('') || '<div class="loading">No projects</div>';
    }
    
    function renderTopics() {
      document.getElementById('topics').innerHTML = topics.map(topic => {
        // Find matching tweets by keywords
        const matching = tweets.filter(t => {
          const text = (t.text || '').toLowerCase();
          return (topic.keywords || []).some(kw => text.includes(kw.toLowerCase()));
        });
        
        return `
          <div class="topic-card">
            <div class="topic-header">
              <div class="topic-badge">${matching.length}</div>
              <div class="topic-info">
                <div class="topic-name">${topic.name}</div>
                <div class="topic-summary">${topic.summary || ''}</div>
                <div class="topic-meta">
                  <span>ðŸ“Š ${matching.length} tweets</span>
                  <span>ðŸ”— ${(topic.keywords || []).length} keywords</span>
                </div>
              </div>
            </div>
            <div class="topic-content">
              ${matching.slice(0, 3).map(t => `
                <div class="tweet-mini">
                  <div class="tweet-author">@${t.authorHandle || t.author || 'unknown'}</div>
                  <div class="tweet-text">${(t.text || '').slice(0, 200)}...</div>
                  <a href="${t.url}" target="_blank" class="tweet-link">â†— View on X</a>
                </div>
              `).join('') || '<div class="loading">No matching tweets</div>'}
            </div>
          </div>
        `;
      }).join('') || '<div class="loading">No topics</div>';
    }
    
    load();
  </script>
</body>
</html>
